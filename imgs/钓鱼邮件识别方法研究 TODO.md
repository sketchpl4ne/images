论文名称：《钓鱼邮件识别方法研究》

发表期刊：广州大学硕士学位论文

发表时间：2023年5月28日

作者：肖怡含

# 绪论

## 研究背景

钓鱼邮件危害很大，钓鱼邮件的检测技术很重要，略。

## 研究现状

本文依照钓鱼邮件检测方法的发展，将现有的研究分为4类：**基于黑名单、基于规则、基于机器学习、基于深度学习**。

**基于黑名单的钓鱼邮件识别方法：**

1. 核心思想：维护一个黑名单数据库（IP、域名等），符合黑名单的邮件全部被过滤。
2. 优点：简单、迅速。
3. 缺点：黑名单的更新存在滞后性，无法应对新出现的钓鱼邮件攻击。

**基于规则的钓鱼邮件识别方法：**

1. 核心思想：由研究者设定一个规则（网页相似度、网页排名等），根据规则来判断是否为钓鱼邮件。
2. 优点：简单有效
3. 缺点：设定的规则需要不断地更新，也存在被绕过的可能

**基于机器学习的钓鱼邮件识别方法：**

1. 核心思想：人工提取特征作为输入，使用某个机器学习分类算法训练模型，然后使用模型进行分类判断。
2. 优点：实现简单，对计算资源、数据量的要求不高；机器学习算法的可解释性强
3. 缺点：特别依赖特征的提取，同时需要人工设置特征提取的方法；训练出来的模型泛化能力弱，只针对特定数据集有效，如果遇到新的数据集，则需要重新训练模型。

**基于深度学习的钓鱼邮件识别方法：**

1. 核心思想：将深度学习技术，应用在钓鱼邮件检测中，
2. 优点：自动提取特征、模型具备泛化能力、性能更好
3. 缺点：**a. 使用多任务、多模态、多视图结合深度学习的文献还比较少；b. 特征分析不全面 c. 可解释性和鲁棒性差**

## 研究内容

**特征表示的优化**：提出了一种基于多层次多特征的钓鱼邮件特征分析方法。a. 针对基础层字词特征、逻辑层语义特征、认知层情感特征、字符层 URL 特征4个方面，由浅入深地对钓鱼邮件正文特征进行分析并提出合适的特征表示方法；b. 针对邮件附件，提出了附件名关联特征和正文相关系数特征两个新特征及特征表示方法，从而更全面的更系统的分析钓鱼邮件的特征。

**模型的优化**： 本文提出一种基于多通道 BiLSTM+Attention 钓鱼邮件识别模型。a. 该模型将多层次特征分别输入到多通道网络中进行处理和分析，并引入 BiLSTM模型来学习文本特征上下文依赖关系；b. 引入自适应Dropout 正则化方法来提高模型泛化能力；c. 模型还引入了缩放点积注意力机制来加强模型的关注度；d. 针对邮件数据集的不平衡问题，模型还引入了一种改进的二元交叉熵损失函数，即聚焦损失函数(Focal Loss)来对模型进行优化。 这种多层次的特征可以更容易地解释为人类可以理解的概念，从而提高模型可解释性，且可以有效地减小数据维度，具有很强的抗噪声能力，有效地提高模型的鲁棒性

**系统实现：** 用户上传制定格式数据或者eml文件，系统自动识别是否为钓鱼邮件。（功能有点简单）


# 相关技术

主要介绍：钓鱼邮件常见攻击方式、文本特征表示方法、情感分析方法、深度学习方法四个方面的技术。

## 钓鱼邮件常见攻击方式

主要有三种，分别是恶意链接、恶意附件、回复式。

**基于恶意链接的钓鱼邮件：**

1. 本质：在邮件正文中嵌入恶意的url链接，欺骗用户点击恶意链接达到各种攻击的目的。
2. 类型：a. 钓鱼网站 b. 短网址 c. 重定向

**基于恶意附件的钓鱼邮件：**

1. 本质：诱导用户执行恶意附件，从而达到攻击的目的
2. 类型：a. 普通附件 b. 加密附件/加密云附件 c.二维码图片附件

**基于回复式的钓鱼邮件：**

1. 本质：以命令的语气，要求用户回复敏感信息，很多用户会如实回复
2. 类型：纯文本


## 文本特征表示方法

文本特征表示：将单词或短语转换成计算机能够理解的形式，即文本特征。转化后可以用于深度学习输入。

主要包含三种编码表示：One-Hot、TF-IDF和Word2Vec

### One-Hot

1. 定义：将每个单词映射为一个唯一整数，然后把整数转成维度是词汇表大小的向量，整数对应位置1其余位置置0。
2. 优点：简单，易懂
3. 缺点：显然句子越长，词向量的维度越高，容易引起维度灾难

### TF-IDF

1. 定义：论文没说
2. 评判标准：TF-IDF = TF x IDF，其中TF是词在文档中的频率，IDF是包含该词的文档数量的倒数。TF越高，词在文档出现频率越高，词越重要；IDF越高，包含该词的文档越少，说明该词越重要。**总结：TF-IDF越高，词越重要。**
3. 优点：pass
4. 缺点：pass

### Word2Vec（不太懂）

1. 定义：一种基于神经网络的词向量表示方法。采用固定长度的词向量，相似的单词，词向量的距离近，反之则远。
2. 训练方式：CBOW和Skip-Gram，前者根据上下文预测中心词，后者相反。
3. 优点：论文没说
4. 缺点：论文没说

## 情感分析方法

情感分析，即使用计算机技术，分析文本中包含的情感倾向。 目前常见的有基于情感词典和基于机器学习两种方法。

### 基于情感词典的情感分析方法

1. 本质：利用现成的情感字典，对输入文本做命中统计，计算情感分数，得到情感分类结果。
2. 优点：简单、易实现
3. 缺点：结果受情感词典的质量影响，收集词典费时费力，达不到预期效果

### 基于机器学习的情感分析方法

1. 本质：传统机器学习路子，投喂大量带标注的文本数据，训练出一个模型来判别情感。
2. 优点：可以适应多种语言，并且通过不断训练模型来优化模型
3. 缺点：需要大量带标注数据；需要持续改进特征提取和模型选择

### SnowNLP 介绍

Snow NLP 是基于机器学习的中文自然语言处理工具包，使用基于统计和机器学习的算法来处理中文文本，包括文本分类、情感分析、中文分词、词性标注、关键词提取等任务。SnowNLP 情感分析的底层原理是朴素贝叶斯算法。公式略。

## 深度学习方法

深度学习基于多层神经网络，其核心思想是建立一个多层次的神经网络模型，让模型从原始数据中提取有用的特征和模式，实现对数据的分类、预测、生成等任务。

深度学习包括多种不同的网络和算法，如循环神经网络、注意力机制等，下面将分别介绍循环神经网络以及它的变种方法长短期记忆网络、双向长短期记忆网络，最后再介绍一种用来提高神经网络性能的技术，即注意力机制。

### RNN（不太懂）

定义：RNN即循环神经网络，主要用于处理有时间相关性的序列数据。

结构：神经元的输出不仅依赖于当前输入，还依赖于之前的输入，由此可以达到短时记忆的效果。以下图t时刻的输出St为例，他受St-1（t-1时刻输出）和Xt（t时刻输入）的综合影响。

![[Pasted image 20240730044745.png]]
缺点：CNN只能短期记忆。

### LSTM（不太懂）

定义：LSTM全称长短期记忆神经网络，引入门控单元，解决CNN只能短期记忆的问题。

结构：通过引入三个门控单元，分别是输入门i、遗忘门f和输出门o，以及一个记忆单元来控制状态的更新和遗忘。输入门控制信息的输入，遗忘门控制过去信息的保留，输出门控制输出的信息，长期记忆c，短期记忆h。

![[Pasted image 20240730051026.png]]

缺点：LSTM只能按照时间的正向顺序处理输入序列，无法利用序列中的未来信息，影响了模型的预测准确性。

### BiLSTM（不太懂）

定义：BiLSTM，即双向长短期记忆神经网络，双向循环结构，解决无法利用序列的未来信息的问题。

结构：BiLSTM中包含两个 LSTM 单元，一个按正向顺序处理输入序列，一个按逆向顺序处理输入序列，这样每个时间步的输出就包含了前向和后向两个方向的信息。这样在处理序列任务时，BiLSTM能够更好地捕捉序列中的长期依赖关系，同时利用了序列中的过去和未来信息，提高了模型的预测准确度。

![[Pasted image 20240730052514.png]]

缺点：没有

### AM（不太懂）

定义：AM即注意力机制，是一种用于加强神经网络对输入数据中不同部分的关注度的技术，被频繁地使用到以 RNN 或 CNN 等神经网络模型为基础的各种自然语言处理任务中。

原理：注意力机制通过对输入序列中每个元素分配不同的权重，使模型能够更好地关注重要的信息，同时忽略无用的信息。具体而言，注意力机制会计算每个输入元素与模型输出之间的相似度，从而得到一个权重向量，即根据Query 和 Key 计算权重，注意力权重越大则会越聚焦于其对应的Value 值上。根据权重系数对Value 进行加权求和。 最终得到一个加权向量，作为模型的输出。


![[Pasted image 20240730052734.png]]


# 特征分析

**痛点分析：** 传统的深度学习把邮件整体作为输入，希望能提取到邮件的深层特征。然而，恶意邮件相对于普通邮件非常稀少，这就使深度学习模型学习深层次特征比较困难，此外，传统特征分析还忽略了UR 特征和附件特征，进而影响模型识别效果。**因此，本文通过对大量钓鱼邮件进行分析，提出了基于多层次多特征的钓鱼邮件特征分析方法**，如图3-1:

![[Pasted image 20240801003033.png]]


**解决方案：** 本文从基础层字词特征、逻辑层语义特征、认知层情感特征、字符层 URL 特征四个方面，由浅入深地对钓鱼邮件正文特征进行分析。

1. 在字词特征方面，使用一种改进 TF-IDF 的方法选出可以区分钓鱼邮件和正常邮件的特征词；
2. 在语义特征方面，基于邮件语料库构建词向量模型，获得能同时表征中英文单词语义信息的Word2Vec 词向量特征；
3. 在情感特征方面，针对钓鱼邮件的特点，制作了针对钓鱼邮件恐惧、好奇、紧迫情感的情感文本语料库，弥补了情感语料库在特定领域的不足；
4. 在URL特征方面，使用N-gram分词及字符级编码的方式获取能表征特殊符号语义的词向量。
5. 最后，传统的基于深度学习的方法都没有提及附件特征，提出附件名关联特征、正文相关系数特征两个新特征。


## 字词特征（疑问）

本节首先使用分词模块(例如，jieba)对中英文邮件的正文部分做分词，然后利用改良的TF-IDF算法计算词的权重，最后得出一个特征词集合。

**问题：特征词集合有什么用？**
![[Pasted image 20240801020131.png]]


## 语义特征

本节使用Word2Vec模型获取邮件正文词向量作为邮件的逻辑层语义特征，包括构建语料库、数据预处理、训练模型和保存模型4个步骤，训练好的模型中，每个词语对应一个 100 维的向量，向量可以根据语义进行加减操作。然后，在深度学习中，可以使用该预训练模型将钓鱼邮件正文中的词语映射成词向量，从而获取邮件的深度语义特征。

1. 构建语料库：使用中英文混合邮件的正文作为代表性的邮件领域语料库，这样训练的词向量模型不仅可以捕捉邮件中特定的语言使用习惯，还可以满足邮件中多语言文本分析和处理。
2. 数据预处理：分词，中文使用jieba，英文直接空格；去除停用词，中文用停用词库，英文用nltk、spacy库；最后中文繁简体转换，英文大小写转化
3. 训练模型：使用Word2Vec的CBOW架构进行模型训练，深度学习框架采用keras，调参如下：
![[Pasted image 20240801024604.png]]

4. 保存模型：将训练好的词向量模型保存起来，之后可以使用训练好的Word2Vec模型将单词转换为向量表示，作为深度学习任务的输入。

## 情感特征

**传统钓鱼邮件情感特征：**

一般使用情感词典，直接将句子里的词语词典进行匹配，然后加和计算出句子的情感分值得到情感倾向。目前国内研究成熟的词典有大连理工情感词本体库、知网HowNet 情感词典及台湾大学中文情感极性词典等。

但是，这些情感词典库通常是静态的，不会随着时间和新的钓鱼邮件数据集的更新而更新。这可能导致钓鱼邮件中一些新的情感特征无法被准确地识别。

另外，“奖励”、“抽奖”等词语在钓鱼邮件中明显为了吸引受害者的好奇情感，“病毒感染”、“修复”、“交易异常”在钓鱼邮件中表达了恐惧、紧张的情感，但是这些词在一般的语料库中一般不会出现。

因此，本文根据钓鱼邮件特定领域构建针对性的情感语料库。此外，使用有监督的机器学习方法，通过使用机器学习算法对钓鱼邮件领域的情感语料库数据进行训练，得到训练好的模型之后，就可以通过模型计算邮件的情感倾向，不受限于情感词典中词语的数量。

**情感分析及语料库构建：**

本文通过收集和分析大量钓鱼邮件，将钓鱼邮件常见的主题分为紧急行动、账户验证、财务诈骗、交易异常、病毒警报、奖励信息、特价优惠 7 类，把其中蕴含的情感总结为好奇、紧张、恐惧 3 类，其情感强度由弱到强。

接下来，分别分析每类钓鱼邮件与情感的对应关系，结果如表 3-4 所示，可以发现大部分钓鱼邮件的情感是多种的，不能通过一种情感对钓鱼邮件进行分类，因此，本文把恐惧、紧张、好奇情感定义为钓鱼邮件的负面情感，邮件中的负面情感越强，那么表明该邮件越可能是钓鱼邮件。

![[Pasted image 20240801032443.png]]

对于正面情感，本文同样收集了多种类型日常生活中的正常邮件作为正面情感语料库。

**基于 SnowNLP 的情感特征分析：**

SnowNLP是一个基于 Python 的文本分析库，专门用于文本内容的分析，其底层原理是朴素贝叶斯算法。首先读取己经分类的消极语料库与积极语料库训练一个朴素贝叶斯分类器，接着对需要情感打分的文本数据计算出每个词汇的正负极性的后验概率，最后将概率转换为情感得分。

基于 SnowNLP 进行情感分析包括3个步骤：自定义情感语料库、训练情感分类器和计算情感特征值。

1. 自定义情感语料库：将准备好的正面/负面情感语料库分别以文本格式保存，并对语料库进行合理的处理和清洗，以提高情感分类的准确度。
2. 训练情感分类器：使用 SnowNLP 提供的 sentiment.train 方法加载自定义情感语料库，SnowNLP 使用了朴素贝叶斯算法和最大熵模型来实现情感分类器的训练。
3. 计算情感特征值：对于待分析的钓鱼邮件文本，使用 SnowNLP 的 sentiment 方法对其进行情感分析，情感分类器会利用训练数据中已经标注好的情感类别来计算每个词汇属于不同情感类别的概率，并使用朴素贝叶斯算法或最大熵模型来进行分类。最终，SnowNLP 会根据每个词汇的情感值以及整体文本的情感分布，返回情感极性值，值越接近 1 表示情感越积极，越接近 0 表示情感越消极。分别使用原始语料库和自定义语料库对邮件正文情感值进行计算，正常邮件和钓鱼邮件情感值计算结果。
   
根据图 3-2 所示，原始语料库的邮件情感值分布比较平均，正常邮件和钓鱼邮件情感值差距较小，使用自定义语料库后，钓鱼邮件中的负向情感被更好的发现，钓鱼邮件整体情感值降低，正常邮件由于负面情感较少，更容易被认为不是负面情感，因此情感值较高。

![[Pasted image 20240801033525.png]]

为了更详细分析邮件的情感值，图 3-3 显示了实验原始语料库和自定义语料库前后的情感值平均值，可以看到原始语料库中，钓鱼邮件和正常邮件情感值差距较小，只有0.15 左右，再使用自定义语料库后，钓鱼邮件和正常邮件情感值差距达到 0.8，可以更好的区分钓鱼邮件和正常邮件。
![[Pasted image 20240801035707.png]]
## URL特征

**传统邮件URL特征：**

传统识别钓鱼邮件 URL 的方法一般是基于先验知识，通过预先定义一组规则来识别钓鱼邮件中的URL。

传统钓鱼邮件识别中的主要使用的URL 特征如表 3-6 所示：

![[Pasted image 20240801042347.png]]

**N-gram分词介绍：**

URL 是一种特殊的文本，通常包含大量的非中文字符，例如数字、字母和特殊字符等，URL 语法以及字符串格式与传统文本出入较大，它不能使用传统的分词方法，本文使用N-gram分词。

N-gram是自然语言处理领域中的一个术语，它指的是文本中由N个连续的单词(或字符)组成的序列。N-gram分词是一种基于 N-gram 模型的分词方法。该方法将文本划分为由 N 个片段，称为 N-gram片段。N-gram 片段可以是字符级别的，也可以是词级别的，这些片段被称为 N-gram。在 N-gram 模型中，每个 N-gram 被视为一个独立的单元，而与它之前或之后的单元无关。它通常用于文本分类、文本生成、机器翻译等任务。在 N-gram 字符级分词中，由于不需要考虑词汇库，所以这种方法适用于处理语言模糊或新词汇的情况。

本文使用 N-gram 分词对 URL 进行分词，通过将 URL 划分为有意义的词汇序列，以便进一步的处理和分析。将 URL 中的每个字符都看作一个单元，然后将相邻的 3 个字符组成一个 3-gram 片段。例如，对于 URL：“https://www.examples.com” ，可以得到以下 3-gram片段序列：
```
“htt”，“ttp”，“tps”，“ps:”，“s:/”，“:/w”，“//w”，“www”，“ww.”，“w.e”，“.ex”，“exa”，“xam”，“amp”，“mpl”，“ple”，“les”“es.”，“s.c”，“.co”，“com”。
```

可以看到，生成的N-gram序列是由三个字符组成的词组。这些N-gram序列可以用于训练一个基于字符级别的语言模型，用于处理各种文本中任务。

分词算法：首先，输入文本字符串和 N-gram 的大小。然后使用一个循环逐个生成 N-gram 序列，并将它们添加到一个列表中。最后，函数返回生成的 N-gram序列。基于N-gram分词过程如算法 3-2 所示
![[Pasted image 20240801043520.png]]

**N-gram + Word2Vec 构建字符级词向量模型：**

1. 数据预处理：对于正文中没有URL 的邮件，需要对URL 字段进行空值填充，本文使用零值填充空URL字段
2. 字符级N-gram 分词：使用上述N-gram算法，生成的N-gram序列
3. 字符级词向量模型训练及保存：使用Word2Vec 模型训练字符级词向量模型，将 3-gram分词好的字符进行Word2Vec训练，获得每个字符的高维度向量，最终获得一个字符级词向量模型，嵌入维度设置为 100。通过图 3-4 可知，大部分邮件中的URL 数量在 5 个以下，一个URL 通过 3-gram进行字符分割可以得到 20 个左右切分好的字符，所以选取 100 作为URL特征长度进行补齐。
![[Pasted image 20240801043628.png]]

## 附件特征 

**传统邮件附件特征：**

传统的通过钓鱼邮件附件特征识别钓鱼邮件的方法包含两种，静态特征和动态特征。具体如下图：

![[Pasted image 20240804115212.png]]

缺点：静态特征过于简单，容易被攻击者绕过，动态特征提取难度大，且分析附件运行是否存在恶意行为的规则是认为设置的，容易被免杀绕过。

**附件名关联特征：**

钓鱼邮件的附件名和正常邮件的附件名存在差异，正常邮件的附件命名通常是清晰、有意义的，而钓鱼邮件附件可能采用吸引人的语言或陌生的名称，所以本文基于附件名来提取特征，作为一个层面的特征向量。

方法：首先将附件名通过特殊符号切分成单词数组，然后用Tokenizer进行编码，即可作为特征向量输入进神经网络。
![[Pasted image 20240804120130.png]]


**正文相关系数：**

首先处理附件名，去除后缀和特殊符号，再使用 jieba 分词对附件名进行拆分，并判断每个拆分的词语是否在邮件正文中，计算附件名中的词语在正文出现的数量，由于附件名的长度及个数都不同，最后需要除以附件名中词语的数量，获得附件的正文相关度特征，特征值范围在\[0,1\]

文章没说这个特征要怎么用，直接把系数作为一个特征值？

# 模型训练

## 引言

传统的基于深度学习的钓鱼邮件检测，一般是邮件文本转词向量，然后输入深度学习分类模型进行训练。

本文由于提取的特征是多层次的，即存在不同类型的特征，都输入相同的神经网络结构显然不够合理，所以提出了基于多通道 BiLSTM-Attention 的钓鱼邮件识别模型。原理是将提取到的多种特征输入到多通道分别处理，然后BiLSTM网络来学习文本特征上下文依赖关系。

同时，引入了自适应Dropout正则化技术来提高模型泛化能力和防止过拟合；引入了缩放点积注意力机制来加强模型的关注度，使其能够更加准确地识别出钓鱼邮件；最后还引入了聚焦损失函数来优化数据集不平衡的问题。

## 模型框架

首先，不同的邮件特征通过不同的通道输入模型，其中语义特征、URL 特征的通道采用 BiLSTM 进行上下文信息提取，然后，将每个通道的输出进行拼接，得到特征联合表示。

其次，引入自适应Dropout 正则化层防止模型过拟合；引入注意力机制加强模型关注度，对全局特征进行加权，加权后的特征向量输入到全连接层进行分类；引入聚焦损失函数，在模型训练时对模型进行优化。

![[Pasted image 20240804145915.png]]


## 模型优化（看不懂）

### 自适应 Dropout 正则化


### 缩放点积注意力机制


### 聚焦损失函数


## 多通道BiLSTM-Attention模型（看不懂）


### 多通道输入层

### 多级嵌入层

### BiLSTM层

### 特征联合层

### 全连接


## 实验结果

### 数据集

**数据来源：** 本文使用奇安信DataCon的coremail 2020 邮件安全数据集，数据集包含 24000 封邮件，其中4804 封钓鱼邮件，19196 封正常邮件，但是没有附件内容。

**预处理：** 由于DataCon2020数据集提供的是邮件服务器的日志文件，而本文主要对邮件正文和附件特征进行分析，所以需要做预处理，提取邮件内容字段、附件名、URL等字段信息。

正则提取URL字段的算法：
![[Pasted image 20240801012639.png]]

最后转成csv格式，下面是处理好的数据集的结构信息：
![[Pasted image 20240801012710.png]]


### 实验环境和配置

本文基于Keras 的 Functional API 来构建模型，服务器配置和超参数配置信息如下。

服务器配置
![[Pasted image 20240804154713.png]]

超参数配置
![[Pasted image 20240804154801.png]]

### 实验结果

**多层次正文特征对比实验：**

针对情感特征，对比使用原始语料库和自定义语料库的分类性能，突出SnowNLP的作用。

针对其余三种特征，分别使用CNN、RNN、LSTM、BiLSTM分类，对比其性能。

![[Pasted image 20240804161401.png]]
![[Pasted image 20240804161426.png]]


**多通道 BiLSTM-Attention 模型对比实验：**

首先，是在BiLSTM-Attention模型的基础上，给模型优化方法做了消融实验；其次是横向对比本文模型和其他模型。

优化方法的消融实验
![[Pasted image 20240804162353.png]]

横向对比
![[Pasted image 20240804162008.png]]

# 系统实现

框架比较简单，可以分成三部分：数据预处理、特征提取、分类。

首先，对已标记的邮件数据做数据预处理、特征提取，得到特征向量后输入进行训练模型；其次，得到模型后对用户输入的待分析邮件做数据预处理、特征提取，得到特征向量后输入训练好的模型，做分类判断。
![[Pasted image 20240804162504.png]]
# 总结

创新点：

1. 针对基于深度学习的钓鱼邮件识别方法中特征表示还不成体系的问题，本文提出了一种基于多层次多特征的钓鱼邮件特征分析方法
2. 针对目前钓鱼邮件识别模型可解释性和鲁棒性差的问题，本文提出一种基于多通道 BiLSTM+Attention 钓鱼邮件识别模型。
